rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- GLOBAL HELPERS ---
    
    function isSignedIn() {
      return request.auth != null;
    }

    // Role check helper
    function isRole(role) {
      return isSignedIn() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }

    function getOrgId() {
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      return (userDoc != null) ? userDoc.data.organizationId : null;
    }

    // --- USER PROFILE RULES ---
    
    match /users/{userId} {
      allow read: if isSignedIn();
      
      allow create: if (isSignedIn() && (
        request.auth.uid == userId ||
        (isRole('owner') && request.resource.data.organizationId == getOrgId())
      )) || (
        // Public Registration via Invite
        request.resource.data.organizationId != null &&
        (request.resource.data.role == 'teacher' || request.resource.data.role == 'student')
      );
      
      allow update: if isSignedIn() && (
        (request.auth.uid == userId && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role'])) ||
        (isRole('owner') && get(/databases/$(database)/documents/users/$(userId)).data.organizationId == getOrgId())
      );

      match /sessions/{sessionId} {
        allow read, write: if isSignedIn() && request.auth.uid == userId;
      }
    }

    // --- ORGANIZATION RULES ---
    
    match /organizations/{orgId} {
      allow read: if true; // Discovery Mode: Public access
      
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      
      allow update: if isSignedIn() && (
        resource.data.ownerId == request.auth.uid || 
        (isRole('owner') && orgId == getOrgId())
      );
    }

    // --- GROUPS RULES ---
    
    match /groups/{groupId} {
      allow read: if true; // Discovery Mode: Public access
      allow write: if isSignedIn() && isRole('owner') && request.resource.data.organizationId == getOrgId();
    }

    // --- MULTI-TENANT DOMAIN RULES ---

    match /{collection}/{docId} {
      
      function belongsToOrg() {
        let currentOrgId = getOrgId();
        let targetOrgId = (resource == null) ? request.resource.data.organizationId : resource.data.organizationId;
        return targetOrgId == currentOrgId;
      }

      // Public Discovery Collections (Read-only)
      function isDiscoveryCollection() {
        return collection in ["faculties", "subjects", "departments", "schedules", "courses"];
      }

      // 1. OWNER: Full access to everything in their org
      allow read, write: if isRole('owner') && belongsToOrg();

      // 2. TEACHER: Specific access
      allow read: if isRole('teacher') && belongsToOrg();
      allow write: if isRole('teacher') && belongsToOrg() && (collection in ["attendance", "grades"]);

      // 3. STUDENT: Own data read-only
      allow read: if isRole('student') && belongsToOrg() && (
        collection in ["schedule", "courses"] ||
        (collection == "attendance" && (resource == null || resource.data.studentId == request.auth.uid)) ||
        (collection == "grades" && (resource == null || resource.data.studentId == request.auth.uid)) ||
        (resource != null && resource.data.studentId == request.auth.uid)
      );

      // 4. DISCOVERY: Public read for educational structure
      allow read: if isDiscoveryCollection();
    }
  }
}
